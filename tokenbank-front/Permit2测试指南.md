# TokenBank Permit2 ç­¾åå­˜æ¬¾æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

TokenBank å‰ç«¯ç°å·²æ”¯æŒä¸‰ç§å­˜æ¬¾æ–¹å¼ï¼š
1. **ä¼ ç»Ÿå­˜æ¬¾**: éœ€è¦å…ˆ `approve` å† `deposit`ï¼Œæ¶ˆè€—ä¸¤æ¬¡ gas
2. **EIP-2612 ç­¾åå­˜æ¬¾**: ä½¿ç”¨ `permit` ç­¾åï¼Œä¸€æ¬¡äº¤æ˜“å®Œæˆï¼ŒèŠ‚çœ gas
3. **Permit2 ç­¾åå­˜æ¬¾**: ä½¿ç”¨ Permit2 åè®®ï¼Œæä¾›æ›´å¼ºå¤§çš„ç­¾åæˆæƒæœºåˆ¶

## å‰ç½®æ¡ä»¶

### 1. åˆçº¦éƒ¨ç½²è¦æ±‚
ç¡®ä¿ä»¥ä¸‹åˆçº¦å·²æ­£ç¡®éƒ¨ç½²ï¼š

```bash
# 1. éƒ¨ç½²æ”¯æŒ EIP-2612 çš„ Token (BaseERC20)
forge script script/DeployMyToken.s.sol --rpc-url sepolia --broadcast --verify

# 2. éƒ¨ç½² TokenBank (éœ€è¦åŒ…å« permit2Address)
forge script script/TokenBank.s.sol --rpc-url sepolia --broadcast --verify
```

### 2. å‰ç«¯é…ç½®
æ›´æ–° `tokenbank-front/src/app/page.tsx` ä¸­çš„åˆçº¦åœ°å€ï¼š

```typescript
const TOKENBANK_ADDRESS = "0xä½ çš„TokenBankåˆçº¦åœ°å€" as `0x${string}`;
const TOKEN_ADDRESS = "0xä½ çš„BaseERC20åˆçº¦åœ°å€" as `0x${string}`;
```

### 3. ç”¨æˆ·å‡†å¤‡
- é’±åŒ…è¿æ¥åˆ° Sepolia æµ‹è¯•ç½‘
- æŒæœ‰è¶³å¤Ÿçš„æµ‹è¯• ETH ç”¨äº gas è´¹ç”¨
- æŒæœ‰ä¸€å®šæ•°é‡çš„æµ‹è¯• Token (BAPE)

## æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: å¯åŠ¨å‰ç«¯åº”ç”¨

```bash
cd tokenbank-front
npm install
npm run dev
```

è®¿é—® `http://localhost:3000`

### æ­¥éª¤ 2: è¿æ¥é’±åŒ…

1. ç‚¹å‡»"è¿æ¥é’±åŒ…"æŒ‰é’®
2. é€‰æ‹© MetaMask æˆ–å…¶ä»–é’±åŒ…
3. ç¡®è®¤è¿æ¥åˆ° Sepolia æµ‹è¯•ç½‘
4. ç¡®è®¤æ˜¾ç¤ºæ­£ç¡®çš„é’±åŒ…åœ°å€å’Œä½™é¢

### æ­¥éª¤ 3: æµ‹è¯•ä¼ ç»Ÿå­˜æ¬¾

1. åœ¨"å­˜æ¬¾åˆ°TokenBank"åŒºåŸŸé€‰æ‹©"ä¼ ç»Ÿå­˜æ¬¾"
2. è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆä¾‹å¦‚ï¼š10ï¼‰
3. ç‚¹å‡»"å­˜æ¬¾"æŒ‰é’®
4. ç¡®è®¤ä¸¤æ¬¡äº¤æ˜“ï¼š
   - ç¬¬ä¸€æ¬¡ï¼š`approve` æˆæƒ
   - ç¬¬äºŒæ¬¡ï¼š`deposit` å­˜æ¬¾
5. éªŒè¯ä½™é¢å˜åŒ–

### æ­¥éª¤ 4: æµ‹è¯• EIP-2612 ç­¾åå­˜æ¬¾

1. é€‰æ‹©"EIP-2612"é€‰é¡¹
2. è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆä¾‹å¦‚ï¼š5ï¼‰
3. ç‚¹å‡»"EIP-2612ç­¾åå­˜æ¬¾"æŒ‰é’®
4. åœ¨é’±åŒ…ä¸­ç­¾åï¼ˆ**æ³¨æ„**: è¿™æ˜¯ç­¾åï¼Œä¸æ˜¯äº¤æ˜“ï¼‰
5. ç¡®è®¤ä¸€æ¬¡äº¤æ˜“ï¼š`permitDeposit`
6. éªŒè¯ä½™é¢å˜åŒ–

### æ­¥éª¤ 5: æµ‹è¯• Permit2 ç­¾åå­˜æ¬¾

1. é€‰æ‹©"Permit2"é€‰é¡¹
2. è¾“å…¥å­˜æ¬¾é‡‘é¢ï¼ˆä¾‹å¦‚ï¼š8ï¼‰
3. ç‚¹å‡»"Permit2ç­¾åå­˜æ¬¾"æŒ‰é’®
4. åœ¨é’±åŒ…ä¸­ç­¾å Permit2 æ¶ˆæ¯ï¼ˆ**æ³¨æ„**: è¿™æ˜¯ EIP-712 ç­¾åï¼‰
5. ç¡®è®¤ä¸€æ¬¡äº¤æ˜“ï¼š`depositWithPermit2`
6. éªŒè¯ä½™é¢å˜åŒ–

## é¢„æœŸç»“æœ

### æˆåŠŸæŒ‡æ ‡
- âœ… æ‰€æœ‰ä¸‰ç§å­˜æ¬¾æ–¹å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- âœ… ä½™é¢æ­£ç¡®æ›´æ–°ï¼ˆé’±åŒ…ä½™é¢å‡å°‘ï¼Œé“¶è¡Œå­˜æ¬¾å¢åŠ ï¼‰
- âœ… æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- âœ… ç­¾åå­˜æ¬¾åªéœ€è¦ä¸€æ¬¡äº¤æ˜“
- âœ… ä¸åŒå­˜æ¬¾æ–¹å¼æ˜¾ç¤ºå¯¹åº”çš„æŒ‰é’®æ–‡æœ¬å’Œæç¤ºä¿¡æ¯

### æ€§èƒ½å¯¹æ¯”
- **ä¼ ç»Ÿå­˜æ¬¾**: 2 æ¬¡äº¤æ˜“ï¼Œè¾ƒé«˜ gas è´¹ç”¨
- **EIP-2612**: 1 æ¬¡äº¤æ˜“ + 1 æ¬¡ç­¾åï¼ŒèŠ‚çœçº¦ 50% gas
- **Permit2**: 1 æ¬¡äº¤æ˜“ + 1 æ¬¡ç­¾åï¼Œæ”¯æŒæ›´å¤æ‚çš„æˆæƒé€»è¾‘

## è°ƒè¯•ä¿¡æ¯

### æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š

```
ğŸ”§ å‰ç«¯é…ç½®ä¿¡æ¯:
- TOKEN_ADDRESS: 0x4e7C8e2c43aC1d69811D2d00d5AD385dB43899fa
- TOKENBANK_ADDRESS: 0x3B8C8BAEf7f3885159A347B8515AEB8123A76aD5

ğŸš€ å¼€å§‹Permit2ç­¾åå­˜æ¬¾æµç¨‹
- address: 0x...
- amount: 8000000000000000000
- nonce: 1753627542635123456
- deadline: 1703927542
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. "Permit2ç­¾åå¤±è´¥"
**å¯èƒ½åŸå› **: 
- Permit2 å®˜æ–¹åˆçº¦æœªéƒ¨ç½²åˆ°å½“å‰ç½‘ç»œ
- ç­¾åæ ¼å¼ä¸æ­£ç¡®
- nonce å†²çª

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// æ£€æŸ¥ PERMIT2_ADDRESS æ˜¯å¦æ­£ç¡®
const PERMIT2_ADDRESS = "0x000000000022D473030F116dDEE9F6B43aC78BA3";
```

#### 2. "æ— æ³•è·å– DOMAIN_SEPARATOR"
**å¯èƒ½åŸå› **: Token åˆçº¦ä¸æ”¯æŒ EIP-2612

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ä½¿ç”¨çš„æ˜¯ BaseERC20 åˆçº¦ï¼Œä¸æ˜¯æ™®é€šçš„ ERC20

#### 3. "åˆçº¦è°ƒç”¨å¤±è´¥"
**å¯èƒ½åŸå› **: 
- TokenBank åˆçº¦åœ°å€ä¸æ­£ç¡®
- åˆçº¦æœªåŒ…å« `depositWithPermit2` å‡½æ•°
- ç”¨æˆ·ä½™é¢ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**: 
- é‡æ–°éƒ¨ç½² TokenBank åˆçº¦
- æ£€æŸ¥åˆçº¦åœ°å€é…ç½®
- ç¡®è®¤ç”¨æˆ·æœ‰è¶³å¤Ÿçš„ Token ä½™é¢

## æŠ€æœ¯ç»†èŠ‚

### Permit2 ç­¾åç»“æ„
```typescript
domain: {
  name: "Permit2",
  version: "1", 
  chainId: 11155111,
  verifyingContract: "0x000000000022D473030F116dDEE9F6B43aC78BA3"
}

types: {
  PermitTransferFrom: [
    { name: "permitted", type: "TokenPermissions" },
    { name: "nonce", type: "uint256" },
    { name: "deadline", type: "uint256" }
  ],
  TokenPermissions: [
    { name: "token", type: "address" },
    { name: "amount", type: "uint256" }
  ]
}
```

### åˆçº¦è°ƒç”¨å‚æ•°
```solidity
function depositWithPermit2(
    uint256 amount,
    uint256 nonce, 
    uint256 deadline,
    SignatureTransferDetails calldata transferDetails,
    bytes calldata signature
) public
```

## ä¸‹ä¸€æ­¥

æµ‹è¯•å®Œæˆåï¼Œä½ å¯ä»¥ï¼š
1. éƒ¨ç½²åˆ°ä¸»ç½‘ï¼ˆè®°å¾—æ›´æ–°é…ç½®ï¼‰
2. æ·»åŠ æ›´å¤š Token æ”¯æŒ
3. å®ç°æ‰¹é‡å­˜æ¬¾åŠŸèƒ½
4. é›†æˆåˆ° DeFi åè®®ä¸­

---

**æ³¨æ„**: Permit2 æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œä½†éœ€è¦ç”¨æˆ·ç†è§£ç­¾åçš„å«ä¹‰ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ·»åŠ è¯¦ç»†çš„ç”¨æˆ·æ•™è‚²å’Œå®‰å…¨æç¤ºã€‚ 